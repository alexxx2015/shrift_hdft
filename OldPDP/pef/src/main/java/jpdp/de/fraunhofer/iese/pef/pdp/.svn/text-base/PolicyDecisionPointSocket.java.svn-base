package de.fraunhofer.iese.pef.pdp;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.PrintWriter;
import java.net.Socket;
import java.util.ArrayList;

import de.fraunhofer.iese.pef.pdp.internal.Decision;
import de.fraunhofer.iese.pef.pdp.internal.Event;
import de.fraunhofer.iese.pef.pdp.internal.IPolicyDecisionPoint;

public class PolicyDecisionPointSocket implements IPolicyDecisionPoint
{
  public static IPolicyDecisionPoint curInstance=null;
  public static boolean              pdpRunning =false;

  public static IPolicyDecisionPoint getInstance()
  {
    if(curInstance==null) curInstance=new PolicyDecisionPointSocket();
    return curInstance;
  }
  
  private PolicyDecisionPointSocket()
  {
  }

  public int init()
  { // deploying initial HSR-policy
    int ret=pdpDeployPolicy("c:\\local\\rd\\usr\\home\\moucha\\aalpol1.xml");
    System.out.println("deploying returned=[" + ret + "]");

    String mechanisms=listDeployedMechanisms();
    System.out.println("listDeployedMechanisms returned=[" + mechanisms + "]");

    return ret;
  }
  
  @Override
  public int pdpStart()
  {return 0;}

  @Override
  public int pdpStop()
  {return 0;}
  
 
  @Override
  public String listDeployedMechanisms()
  {
    return pdpCommunication("3");
  }
  
  @Override
  public String pdpNotifyEventXML(String event)
  {
    return pdpCommunication("2" + event);
  }
  
  @Override
  public int pdpDeployPolicy(String filename)
  {
    return pdpCommunication("0" + filename).equals("success") ? 1 : 0;
  }


  @Override
  public int pdpDeployMechanism(String mechanism_doc_path, String mechName)
  {
    // TODO Auto-generated method stub
    return 0;
  }

  @Override
  public int pdpRevokeMechanism(String mechName)
  {
    // TODO Auto-generated method stub
    return 0;
  }

  @Override
  public int setRuntimeLogLevel(int newLevel)
  {
    // TODO Auto-generated method stub
    return 0;
  }
  
  @Override
  public Decision pdpNotifyEventJNI(Event event)
  {
    // TODO Auto-generated method stub
    return null;
  }
  
  private String pdpCommunication(String request)
  {
    Socket pdpSocket=null;
    String pdpResponse=null;
    String msg=null;
    try
    {
      pdpSocket= new Socket("127.0.0.1",9999);
      msg = request + "\r\n";
    }
    catch(Exception e)
    {
      System.out.println("error creating socket");
      e.printStackTrace();
    }
    
    try
    {
      PrintWriter printWriter=new PrintWriter(new OutputStreamWriter(pdpSocket.getOutputStream()));
      printWriter.print(msg);
      printWriter.flush();
    }
    catch(Exception e)
    {
      System.out.println("error sending socket message");
      e.printStackTrace();
    }
    
    try
    {
      // TODO: looped reading
      BufferedReader responseReader = new BufferedReader(new InputStreamReader(pdpSocket.getInputStream()));
      char[] buffer = new char[4096];
          
      int anzahlZeichen = responseReader.read(buffer, 0, 4096);
      pdpResponse = new String(buffer, 0, anzahlZeichen);
          
      //System.out.println("#"+pdpResponse+"#");
    }
    catch(Exception e)
    {
      System.out.println("error receiving answer from socket");
      e.printStackTrace();
    }

    try 
    {
      pdpSocket.close();
    } 
    catch (Exception e) 
    {
      System.out.println("error closing socket");
      e.printStackTrace();
    }
    return pdpResponse;
  }

  @Override
  public int pdpDeployPolicyString(String policy)
  {
    // TODO Auto-generated method stub
    return 0;
  }

  @Override
  public int pdpDeployMechanismString(String policy, String mechName)
  {
    // TODO Auto-generated method stub
    return 0;
  }

  @Override
  public ArrayList<String> listDeployedMechanismsJNI()
  {
    // TODO Auto-generated method stub
    return null;
  }

@Override
  public int registerPEP(String pepName, String className, String methodName,
		String methodSignature) 
  {
	// TODO Auto-generated method stub
	return 0;
  }

@Override
public int registerAction(String actionName, String pepName) {
	// TODO Auto-generated method stub
	return 0;
}

@Override
public int registerPXP(String pepName, String className, String methodName, String methodSignature)
{
  // TODO Auto-generated method stub
  return 0;
}

@Override
public int registerExecutor(String actionName, String pepName)
{
  // TODO Auto-generated method stub
  return 0;
}

}


